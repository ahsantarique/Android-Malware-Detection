@echo OFF

setlocal enabledelayedexpansion
 for  %%a in ("*.apk") do (
 	 
     set FileName=%%~a
 
     aapt dump badging !FileName! | grep package | gawk -F: "{print $2}" > tmpfile
	 
     awk "{print substr($1,7,100)}" tmpfile > tmpfile2
	 
	 awk "{print substr($1, 0, length($1)-1)}" tmpfile2 > tmpfile3
	 
	 set /p pName=<tmpfile3 
	 
	 echo !pName!


   rem Here we install
   adb install !FileName!

   rem run monkey
   adb shell monkey -p !pName! -v 50 --throttle 100
   
   adb shell ps | grep  !pName! | awk "{print $2}"> processId
   
   set /p pId=<processId 
   
   adb shell timeout -t 5 strace -c -p !pId! > !pName!.csv
   
   adb shell am force-stop !pName!

   rem uninstall app
   adb shell pm uninstall -k !pName!
 )

 rem adb shell ps
