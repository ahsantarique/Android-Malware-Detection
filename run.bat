@echo OFF

setlocal enabledelayedexpansion

mkdir malware_training_csv
for /R %%a in ("*.apk") do (
 	 
   set FileName="%%~a"

   rem //retrieve package name from an .apk 
   aapt dump badging !FileName! | grep package | gawk -F: "{print $2}" > tmpfile1

   rem //processing data recvd on last statement 
   awk "{print substr($1,7,100)}" tmpfile1 > tmpfile2
   awk "{print substr($1, 0, length($1)-1)}" tmpfile2 > tmpfile3
   set /p pName=<tmpfile3 

   echo !pName!

   rem //install .apk file into device
   adb install !FileName!

   rem //launches an application using only packageName
   adb shell monkey -p !pName! -v 50 --throttle 100
   
   rem //get process id for a package
   adb shell ps | grep  !pName! | awk "{print $2}"> processId
   set /p pId=<processId 
   
   rem //run strace for 10 second, save it to packageName.csv file

   start /B adb shell "su -c 'strace -p !pId!'" > malware_strace_csv\!pName!.csv
   timeout /t 10
   echo !pId!

   rem //force stop an application
   adb shell am force-stop !pName!

   rem //uninstall app
   adb shell pm uninstall -k !pName!

   del tmpfile1
   del tmpfile2
   del tmpfile3
 )

